# Database Refactor Summary - SQLite Reserved Keyword Fix

**Orchestrator Report**  
**Date**: 2026-01-11  
**Issue**: Database save errors due to SQLite reserved keyword 'date'  
**Solution Status**: ‚úÖ Documentation Complete, ‚úÖ Implementation Complete

---

## Problem Statement

The `check_in` table uses `date` as its primary key column, which is a **reserved keyword in SQLite**. This causes save errors when inserting or updating check-in records. The error manifests as conflicts during database operations.

---

## Solution Overview

**Rename**: `date` ‚Üí `check_in_date` across **ALL** tables, foreign keys, triggers, and application code.

---

## Documentation Deliverables

### ‚úÖ 1. `.dbschemarefactor.md` (Updated)

- Updated schema with `check_in_date` as primary key
- Updated all 4 foreign key references
- Added is_immutable field to check_in_color table (was missing)

### ‚úÖ 2. `.dbschemarefactor_v2.md` (New - Detailed Implementation Guide)

- Complete before/after comparison for all changes
- Line-by-line code changes with line numbers
- Migration strategy (v5 ‚Üí v6)
- Validation checklist
- Risk assessment
- Testing requirements

---

## Files Requiring Changes

### Core Database Schema
**File**: [app/lib/core/db/app_database.dart](app/lib/core/db/app_database.dart)

| Line(s) | Component | Change Description |
|---------|-----------|-------------------|
| 15 | CheckIns.date | Rename to `checkInDate` with `.named('check_in_date')` |
| 21 | Primary key | Update `{date}` to `{checkInDate}` |
| 47 | Workouts FK | Update reference to `check_in(check_in_date)` |
| 83 | CheckInColor FK | Update reference to `check_in(check_in_date)` |
| 99 | CheckInPhoto FK | Update reference to `check_in(check_in_date)` |
| 118 | Schema version | Bump from `5` to `6` |
| 147-152 | Trigger (onCreate) | Update `WHEN date <` to `WHEN check_in_date <` |
| 153-158 | Trigger (onCreate) | Update `WHEN date <` to `WHEN check_in_date <` |
| 187+ | Migration | Add v5‚Üív6 migration code block |
| 210-215 | Trigger (onUpgrade) | Update `WHEN date <` to `WHEN check_in_date <` |
| 216-221 | Trigger (onUpgrade) | Update `WHEN date <` to `WHEN check_in_date <` |
| 275 | Query method | Update `.date.equals()` to `.checkInDate.equals()` |

**Total Changes**: 12 locations + 1 new migration block

---

### Application Code
**File**: [app/lib/screens/daily_entry_screen.dart](app/lib/screens/daily_entry_screen.dart)

| Line(s) | Component | Change Description |
|---------|-----------|-------------------|
| 92 | Query | Update `.date.equals()` to `.checkInDate.equals()` |
| 207 | Insert | Update `date: _dateStr` to `checkInDate: _dateStr` |
| ~330 | Insert | Update `date: _dateStr` to `checkInDate: _dateStr` |

**Total Changes**: 3 locations

---

**File**: [app/lib/pages/homescreen_calendar.dart](app/lib/pages/homescreen_calendar.dart)

| Line(s) | Component | Change Description |
|---------|-----------|-------------------|
| 49 | Field access | Update `r.date.split()` to `r.checkInDate.split()` |

**Total Changes**: 1 location

---

### Generated Code (Automatic)
**File**: [app/lib/core/db/app_database.g.dart](app/lib/core/db/app_database.g.dart)

‚ö†Ô∏è **Do NOT manually edit** - Will be regenerated by Drift after schema changes

**Action Required**: Run `dart run build_runner build --delete-conflicting-outputs`

---

## Critical Changes Breakdown

### 1. Table Definition (CheckIns class)
```dart
// CURRENT (‚ùå BROKEN)
TextColumn get date => text()();

// FIXED (‚úÖ WORKS)
TextColumn get checkInDate => text().named('check_in_date')();
```

**Rationale**: The `.named('check_in_date')` tells Drift to use `check_in_date` as the SQL column name, avoiding the reserved keyword.

---

### 2. Foreign Key Constraints (3 locations)
```dart
// CURRENT (‚ùå BROKEN)
'FOREIGN KEY (check_in_date) REFERENCES check_in(date) ON DELETE CASCADE',

// FIXED (‚úÖ WORKS)
'FOREIGN KEY (check_in_date) REFERENCES check_in(check_in_date) ON DELETE CASCADE',
```

**Rationale**: Foreign keys must reference the actual column name in the parent table.

---

### 3. Database Triggers (4 locations - onCreate + onUpgrade)
```sql
-- CURRENT (‚ùå BROKEN)
WHEN date < date('now','localtime')

-- FIXED (‚úÖ WORKS)
WHEN check_in_date < date('now','localtime')
```

**Rationale**: Triggers must reference the actual column name. Note: `date('now','localtime')` is a SQLite **function**, not the column name.

---

### 4. Schema Version & Migration

```dart
// Bump version
int get schemaVersion => 6;

// Add migration (in onUpgrade)
if (from < 6) {
  // Disable foreign keys temporarily
  await customStatement('PRAGMA foreign_keys = OFF');
  await customStatement('BEGIN TRANSACTION');
  
  // Create new table with correct schema
  await customStatement('''
    CREATE TABLE check_in_new (
      check_in_date TEXT PRIMARY KEY,
      weight        REAL,
      height        REAL,
      notes         TEXT
    )
  ''');
  
  // Copy all existing data
  await customStatement('''
    INSERT INTO check_in_new (check_in_date, weight, height, notes)
    SELECT date, weight, height, notes FROM check_in
  ''');
  
  // Replace old table with new
  await customStatement('DROP TABLE check_in');
  await customStatement('ALTER TABLE check_in_new RENAME TO check_in');
  
  await customStatement('COMMIT');
  await customStatement('PRAGMA foreign_keys = ON');
}
```

**Rationale**: Safe migration that preserves all existing data while renaming the column.

---

## Database Triggers

The database includes triggers to enforce immutability for past check-ins. These triggers prevent updates or deletions on check-in records where the `check_in_date` is before the current date.

**Trigger Implementation**:
```sql
-- Prevent updates to past check-ins
CREATE TRIGGER check_in_immutable_update
  BEFORE UPDATE ON check_in
  WHEN OLD.check_in_date < date('now','localtime')
  BEGIN
    SELECT RAISE(ABORT, 'Cannot update past check-ins');
  END;

-- Prevent deletions of past check-ins
CREATE TRIGGER check_in_immutable_delete
  BEFORE DELETE ON check_in
  WHEN OLD.check_in_date < date('now','localtime')
  BEGIN
    SELECT RAISE(ABORT, 'Cannot delete past check-ins');
  END;
```

**Key Points**:
- Uses `OLD.check_in_date` to reference the existing date value
- Compares against `date('now','localtime')` for current date
- Triggers are created in both `onCreate` (fresh installs) and `onUpgrade` (migrations) paths
- Enforces business rule that past entries are immutable

---

## Testing Requirements

### Pre-Implementation Testing
- [ ] Fresh install test (onCreate path)
- [ ] Verify schema version 5 creates correct structure
- [ ] Verify all triggers are created correctly

### Post-Implementation Testing
- [ ] Migration test from v4 ‚Üí v5
- [ ] Verify existing data migrated correctly
- [ ] Save new check-in (INSERT)
- [ ] Update existing check-in (UPDATE)
- [ ] Query check-in by date (SELECT)
- [ ] Delete check-in (verify cascade works)
- [ ] Verify triggers prevent old date modifications
- [ ] Verify foreign key constraints work
- [ ] Verify workout creation links to check-in
- [ ] Verify emotional color creation links to check-in
- [ ] Verify photo creation links to check-in

### Automated ON DELETE CASCADE Test

Add the following integration test to verify ON DELETE CASCADE behavior:

```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:trale/core/db/app_database.dart';

void main() {
  late AppDatabase db;

  setUp(() async {
    db = AppDatabase();
    await db.customStatement('PRAGMA foreign_keys = ON'); // Ensure FKs enabled
  });

  tearDown(() async {
    await db.close();
  });

  test('ON DELETE CASCADE removes related rows when check_in is deleted', () async {
    final checkInDate = '2024-01-15';

    // Create check_in
    await db.checkIns.insertOne(CheckInsCompanion.insert(
      checkInDate: checkInDate,
      weight: 70.0,
      height: 175.0,
      notes: 'Test entry',
    ));

    // Create related workout
    await db.workouts.insertOne(WorkoutsCompanion.insert(
      checkInDate: checkInDate,
      description: 'Test workout',
    ));

    // Create related check_in_color
    await db.checkInColors.insertOne(CheckInColorsCompanion.insert(
      checkInDate: checkInDate,
      color: 0xFF0000FF, // Blue
      message: 'Test emotion',
    ));

    // Create related check_in_photo
    await db.checkInPhotos.insertOne(CheckInPhotosCompanion.insert(
      checkInDate: checkInDate,
      path: '/test/photo.jpg',
      isNsfw: false,
    ));

    // Verify rows exist
    var checkIn = await db.checkIns.getSingleOrNull(checkInDate: checkInDate);
    expect(checkIn, isNotNull);

    var workout = await db.workouts.select().getSingleOrNull();
    expect(workout, isNotNull);

    var color = await db.checkInColors.select().getSingleOrNull();
    expect(color, isNotNull);

    var photo = await db.checkInPhotos.select().getSingleOrNull();
    expect(photo, isNotNull);

    // Delete check_in
    await db.checkIns.deleteWhere((tbl) => tbl.checkInDate.equals(checkInDate));

    // Assert related rows are removed
    checkIn = await db.checkIns.getSingleOrNull(checkInDate: checkInDate);
    expect(checkIn, isNull);

    workout = await db.workouts.select().getSingleOrNull();
    expect(workout, isNull);

    color = await db.checkInColors.select().getSingleOrNull();
    expect(color, isNull);

    photo = await db.checkInPhotos.select().getSingleOrNull();
    expect(photo, isNull);
  });
}
```

This test creates a check_in row with related workout, check_in_color, and check_in_photo rows, deletes the check_in via `appDatabase.delete` (using `checkIns.deleteWhere`), and asserts that related rows in Workout, CheckInColor, and CheckInPhoto tables are removed using `getSingleOrNull()` and `select().getSingleOrNull()` queries.

---

## Implementation Sequence

### Step 1: Schema Updates (db_refactorist)
1. Update `CheckIns` table class definition
2. Update primary key reference
3. Update all 4 foreign key constraints
4. Update both triggers (onCreate path)
5. Update both triggers (onUpgrade path)
6. Bump schema version to 6
7. Add v5‚Üív6 migration code block

### Step 2: Query Method Updates (db_refactorist)
1. Update `getCheckInByDate` method

### Step 3: Build & Generate (db_refactorist)
1. Run: `dart run build_runner build --delete-conflicting-outputs`
2. Verify no build errors
3. Verify app_database.g.dart generated correctly

### Step 4: Application Code Updates (platform_engg)
1. Update daily_entry_screen.dart queries
2. Update daily_entry_screen.dart inserts  
3. Update homescreen_calendar.dart field access
4. Search for any other `.date` references on CheckIn objects

### Step 5: Testing (platform_engg + db_refactorist)
1. Run all test cases listed above
2. Verify no regressions
3. Test on real device/emulator

---

## Risk Mitigation

| Risk | Impact | Mitigation |
|------|--------|------------|
| Data loss during migration | üî¥ CRITICAL | Transaction with rollback; test on backup first |
| Foreign key violations | üü† HIGH | Disable FK during migration; re-enable after |
| Missed references to `.date` | üü† HIGH | Global search for `\.date\b` in Dart files |
| Trigger syntax errors | üü° MEDIUM | Test each trigger individually |
| Build errors | üü° MEDIUM | Use `--delete-conflicting-outputs` flag |

---

## Search Patterns for Verification

Run these searches to catch any missed references:

```bash
# Find all references to .date on CheckIn objects
grep -rn "\.date\b" app/lib/**/*.dart

# Find all CheckInsCompanion usages
grep -rn "CheckInsCompanion" app/lib/**/*.dart

# Find all checkIns table references
grep -rn "checkIns" app/lib/**/*.dart

# Find all check_in string literals in SQL
grep -rn "check_in" app/lib/**/*.dart
```

---

## Rollback Plan

If implementation fails:

1. **Immediate**: Revert all code changes via git
   ```bash
   git checkout -- app/lib/core/db/app_database.dart
   git checkout -- app/lib/screens/daily_entry_screen.dart
   git checkout -- app/lib/pages/homescreen_calendar.dart
   ```

2. **Build**: Regenerate with old schema
   ```bash
   dart run build_runner build --delete-conflicting-outputs
   ```

3. **Database**: Users must clear app data (if in testing)

4. **Schema Version**: Keep at 5 until fix is verified

---

## Success Criteria

‚úÖ **Implementation Complete When:**
- [ ] All 16+ code changes implemented
- [ ] Build succeeds without errors
- [ ] All foreign keys reference correct column
- [ ] All triggers use correct column name
- [ ] Schema version = 6
- [ ] Migration code added and tested
- [ ] Fresh install works
- [ ] Upgrade from v4 works
- [ ] Save check-in works without errors
- [ ] Query check-in works without errors
- [ ] All cascade deletes work correctly

---

## Questions for db_refactorist

1. **Migration Safety**: Do you want to add a backup step before the v5‚Üív6 migration?
2. **Column Naming**: Should we use `checkInDate` (camelCase in Dart) or `check_in_date` everywhere?
   - Recommendation: Use `checkInDate` in Dart code, `.named('check_in_date')` for SQL
3. **Testing**: Do you have existing unit tests for the database layer?
4. **Data Preservation**: Any specific check-in data we should verify after migration?
5. **Performance**: Should we add any new indexes while we're migrating?

---

## Next Steps

### For db_refactorist:
1. Review `.dbschemarefactor_v2.md` for detailed implementation guide
2. Confirm migration strategy is acceptable
3. Begin implementing schema changes in app_database.dart
4. Run build_runner after schema changes
5. Coordinate with platform_engg on application code updates

### For platform_engg:
1. Review the application code changes section
2. After db_refactorist completes schema updates, update:
   - daily_entry_screen.dart
   - homescreen_calendar.dart
3. Run full test suite
4. Test on device/emulator

---

**Report Generated By**: Orchestrator Agent  
**Coordination Required**: db_refactorist ‚ÜîÔ∏è platform_engg  
**Estimated Total Time**: 2-3 hours (implementation + testing)  
**Priority**: üî¥ CRITICAL (blocks save functionality)

---
