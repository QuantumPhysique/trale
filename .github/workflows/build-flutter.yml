name: Build Flutter app for an environment

on: [push]

permissions:
  contents: read
  
jobs:
  deployAndroid:
    permissions: write-all
    name: Build Android apk
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v5
      - name: âš™ï¸ Setup Java
        uses: actions/setup-java@v5
        with:
          java-version: "17.x"
          cache: 'gradle'
          distribution: 'adopt'
        id: java
      - name: Set Flutter version
        run: |
          cd app
          export FLUTTER_VERSION="$(sed -E -n -e 's/^.*flutter:\ ">=([0-9.]+)"/\1/p' pubspec.yaml)"
          echo "FLUTTER_VERSION=$FLUTTER_VERSION" >> $GITHUB_ENV
      - name: âš™ï¸ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "${{ env.FLUTTER_VERSION }}"
          channel: 'stable'
          cache: true
        id: flutter
      - name: ğŸ” Retrieve base64 keystore and decode it to a file
        id: write_file
        uses: timheuer/base64-to-file@v1.2
        with:
          fileName: "android-keystore.jks"
          fileDir: "${{ github.workspace }}/"
          encodedString: ${{ secrets.KEYSTORE_FILE_BASE64 }}
      - name: ğŸ“ğŸ” Create keystore.properties file
        env:
          KEYSTORE_PROPERTIES_PATH: ${{ github.workspace }}/app/android/key.properties
        run: |
          echo "storeFile=${{ github.workspace }}/android-keystore.jks" > $KEYSTORE_PROPERTIES_PATH
          echo "keyAlias=${{ secrets.KEYSTORE_KEY_ALIAS }}" >> $KEYSTORE_PROPERTIES_PATH
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> $KEYSTORE_PROPERTIES_PATH
          echo "keyPassword=${{ secrets.KEYSTORE_KEY_PASSWORD }}" >> $KEYSTORE_PROPERTIES_PATH
      - name: Pub Get Packages
        run: |
          cd app
          flutter --disable-analytics
          flutter pub get --enforce-lockfile
      - name: Lint dart code
        run: |
          cd app
          dart analyze --no-fatal-warnings lib/
      - name: Check dependencies
        run: |
          cd app
          dart run dependency_validator
      - name: Enable KVM group perms
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
      - name: AVD cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-35
      - name: ğŸ§ª Run integration tests with screenshots on Android emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 35
          arch: x86_64
          profile: pixel_9_pro
          script: cd app && flutter drive --driver=test_driver/integration_test.dart --target=integration_test/new_installation_test.dart
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
      - name: â¬†ï¸ ğŸ“¸ Upload integration test screenshots
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: integration-test-screenshots
          path: "app/screenshots/*.png"
          retention-days: 30
          if-no-files-found: warn
      - name: ğŸ¤–ğŸ“¦ Create Android release
        run: |
          cd app
          flutter build apk --split-per-abi --release
      - name: Create Artifact Name
        run: |
          BRANCH_NAME="apks_${{ github.head_ref || github.ref_name }}"
          export ARTIFACT_NAME="${BRANCH_NAME////\_}"
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV
      - name: â¬†ï¸ ğŸ“¦ Upload apks
        uses: actions/upload-artifact@v5
        with:
          name: "${{ env.ARTIFACT_NAME }}"
          path: "app/build/app/outputs/flutter-apk/*.apk"
          retention-days: 30
          overwrite: true
