# Database Schema Refactor v2: Reserved Keyword Fix

**Date**: 2026-01-11  
**Issue**: `date` is a reserved keyword in SQLite causing save conflicts  
**Solution**: Rename `date` ‚Üí `check_in_date` across ALL tables and references  
**Status**: ‚úÖ IMPLEMENTED - Refactor applied; verified in daily_entry_screen.dart

---

## Executive Summary

The `check_in` table currently uses `date` as its primary key column. However, `date` is a **reserved keyword** in SQLite, which causes conflicts and errors when trying to save data. We need to rename this column to `check_in_date` throughout the entire schema and codebase.

### Impact Scope:
- ‚úÖ 1 table definition (CheckIns class)
- ‚úÖ 5 foreign key constraints (in 3 tables)
- ‚úÖ 2 database triggers
- ‚úÖ 1 query method
- ‚úÖ Generated Drift code (app_database.g.dart)
- ‚úÖ Application queries and inserts

---

## 1. `check_in` Table

### Current Schema:
```sql
CREATE TABLE check_in (
    date    TEXT PRIMARY KEY,   -- ‚ùå RESERVED KEYWORD
    weight  REAL,
    height  REAL,
    notes   TEXT
);
```

### New Schema:
```sql
CREATE TABLE check_in (
    check_in_date TEXT PRIMARY KEY,   -- ‚úÖ ISO-8601 YYYY-MM-DD
    weight        REAL,
    height        REAL,
    notes         TEXT
);
```

**Changes Required:**
- Rename column `date` ‚Üí `check_in_date` in Drift table class
- Update primary key reference
- Update all queries using `.date.equals()`

---

## 2. `workout` Table

### Current Schema:
```sql
CREATE TABLE workout (
    check_in_date TEXT PRIMARY KEY,
    description   TEXT,

    FOREIGN KEY (check_in_date)
        REFERENCES check_in(date)          -- ‚ùå References old column
        ON DELETE CASCADE
);
```

### New Schema:
```sql
CREATE TABLE workout (
    check_in_date TEXT PRIMARY KEY,
    description   TEXT,

    FOREIGN KEY (check_in_date)
        REFERENCES check_in(check_in_date)  -- ‚úÖ References new column
        ON DELETE CASCADE
);
```

**Changes Required:**
- Update foreign key constraint string
- No column rename needed (already uses `check_in_date`)

---

## 3. `workout_workout_tag` Table

### Current Schema:
```sql
CREATE TABLE workout_workout_tag (
    check_in_date  TEXT NOT NULL,
    workout_tag_id INTEGER NOT NULL,

    PRIMARY KEY (check_in_date, workout_tag_id),

    FOREIGN KEY (check_in_date)
        REFERENCES workout(check_in_date)   -- ‚úÖ Already correct
        ON DELETE CASCADE,

    FOREIGN KEY (workout_tag_id)
        REFERENCES workout_tag(id)
        ON DELETE CASCADE
);
```

**Changes Required:**
- None (already references workout.check_in_date correctly)

---

## 4. `check_in_color` Table

### Current Schema:
```sql
CREATE TABLE check_in_color (
    check_in_date TEXT NOT NULL,
    ts            INTEGER NOT NULL,
    color_rgb     INTEGER NOT NULL,
    message       TEXT,
    is_immutable  INTEGER NOT NULL DEFAULT 0,

    PRIMARY KEY (check_in_date, ts),

    FOREIGN KEY (check_in_date)
        REFERENCES check_in(date)          -- ‚ùå References old column
        ON DELETE CASCADE
);
```

### New Schema:
```sql
CREATE TABLE check_in_color (
    check_in_date TEXT NOT NULL,
    ts            INTEGER NOT NULL,
    color_rgb     INTEGER NOT NULL,
    message       TEXT,
    is_immutable  INTEGER NOT NULL DEFAULT 0,

    PRIMARY KEY (check_in_date, ts),

    FOREIGN KEY (check_in_date)
        REFERENCES check_in(check_in_date)  -- ‚úÖ References new column
        ON DELETE CASCADE
);
```

**Changes Required:**
- Update foreign key constraint string

---

## 5. `check_in_photo` Table

### Current Schema:
```sql
CREATE TABLE check_in_photo (
    id            INTEGER PRIMARY KEY AUTOINCREMENT,
    check_in_date TEXT NOT NULL,
    file_path     TEXT NOT NULL,
    ts            INTEGER NOT NULL,
    fw            INTEGER NOT NULL DEFAULT 0,

    FOREIGN KEY (check_in_date)
        REFERENCES check_in(date)          -- ‚ùå References old column
        ON DELETE CASCADE
);
```

### New Schema:
```sql
CREATE TABLE check_in_photo (
    id            INTEGER PRIMARY KEY AUTOINCREMENT,
    check_in_date TEXT NOT NULL,
    file_path     TEXT NOT NULL,
    ts            INTEGER NOT NULL,
    fw            INTEGER NOT NULL DEFAULT 0,

    FOREIGN KEY (check_in_date)
        REFERENCES check_in(check_in_date)  -- ‚úÖ References new column
        ON DELETE CASCADE
);
```

**Changes Required:**
- Update foreign key constraint string

---

## 6. Database Triggers

### Trigger 1: `prevent_update_old_checkin`

**Current:**
```sql
CREATE TRIGGER IF NOT EXISTS prevent_update_old_checkin
BEFORE UPDATE ON check_in
WHEN date < date('now','localtime')         -- ‚ùå Uses 'date' column
BEGIN
  SELECT RAISE(ABORT, 'check-in is immutable by date');
END;
```

**New:**
```sql
CREATE TRIGGER IF NOT EXISTS prevent_update_old_checkin
BEFORE UPDATE ON check_in
WHEN check_in_date < date('now','localtime')  -- ‚úÖ Uses 'check_in_date' column
BEGIN
  SELECT RAISE(ABORT, 'check-in is immutable by date');
END;
```

### Trigger 2: `prevent_delete_old_checkin`

**Current:**
```sql
CREATE TRIGGER IF NOT EXISTS prevent_delete_old_checkin
BEFORE DELETE ON check_in
WHEN date < date('now','localtime')         -- ‚ùå Uses 'date' column
BEGIN
  SELECT RAISE(ABORT, 'check-in is immutable by date');
END;
```

**New:**
```sql
CREATE TRIGGER IF NOT EXISTS prevent_delete_old_checkin
BEFORE DELETE ON check_in
WHEN check_in_date < date('now','localtime')  -- ‚úÖ Uses 'check_in_date' column
BEGIN
  SELECT RAISE(ABORT, 'check-in is immutable by date');
END;
```

---

## Comprehensive Code Changes List

### File: `app/lib/core/db/app_database.dart`

#### Change 1: CheckIns Table Definition (Line 15)
```dart
// BEFORE:
TextColumn get date => text()(); // ISO-8601 YYYY-MM-DD

// AFTER:
TextColumn get checkInDate => text().named('check_in_date')(); // ISO-8601 YYYY-MM-DD
```

#### Change 2: CheckIns Primary Key (Line 21)
```dart
// BEFORE:
Set<Column> get primaryKey => {date};

// AFTER:
Set<Column> get primaryKey => {checkInDate};
```

#### Change 3: Workouts Foreign Key (Line 47)
```dart
// BEFORE:
'FOREIGN KEY (check_in_date) REFERENCES check_in(date) ON DELETE CASCADE',

// AFTER:
'FOREIGN KEY (check_in_date) REFERENCES check_in(check_in_date) ON DELETE CASCADE',
```

#### Change 4: CheckInColor Foreign Key (Line 83)
```dart
// BEFORE:
'FOREIGN KEY (check_in_date) REFERENCES check_in(date) ON DELETE CASCADE',

// AFTER:
'FOREIGN KEY (check_in_date) REFERENCES check_in(check_in_date) ON DELETE CASCADE',
```

#### Change 5: CheckInPhoto Foreign Key (Line 99)
```dart
// BEFORE:
'FOREIGN KEY (check_in_date) REFERENCES check_in(date) ON DELETE CASCADE',

// AFTER:
'FOREIGN KEY (check_in_date) REFERENCES check_in(check_in_date) ON DELETE CASCADE',
```

#### Change 6: Trigger 1 - prevent_update_old_checkin (Lines 147-152)
```dart
// BEFORE:
await customStatement('''
  CREATE TRIGGER IF NOT EXISTS prevent_update_old_checkin
  BEFORE UPDATE ON check_in
  WHEN date < date('now','localtime')
  BEGIN
    SELECT RAISE(ABORT, 'check-in is immutable by date');
  END;
''');

// AFTER:
await customStatement('''
  CREATE TRIGGER IF NOT EXISTS prevent_update_old_checkin
  BEFORE UPDATE ON check_in
  WHEN check_in_date < date('now','localtime')
  BEGIN
    SELECT RAISE(ABORT, 'check-in is immutable by date');
  END;
''');
```

#### Change 7: Trigger 2 - prevent_delete_old_checkin (Lines 153-158)
```dart
// BEFORE:
await customStatement('''
  CREATE TRIGGER IF NOT EXISTS prevent_delete_old_checkin
  BEFORE DELETE ON check_in
  WHEN date < date('now','localtime')
  BEGIN
    SELECT RAISE(ABORT, 'check-in is immutable by date');
  END;
''');

// AFTER:
await customStatement('''
  CREATE TRIGGER IF NOT EXISTS prevent_delete_old_checkin
  BEFORE DELETE ON check_in
  WHEN check_in_date < date('now','localtime')
  BEGIN
    SELECT RAISE(ABORT, 'check-in is immutable by date');
  END;
''');
```

#### Change 8: Update Trigger in onUpgrade (Lines 210-215)
```dart
// BEFORE:
await customStatement('''
  CREATE TRIGGER IF NOT EXISTS prevent_update_old_checkin
  BEFORE UPDATE ON check_in
  WHEN date < date('now','localtime')
  BEGIN
    SELECT RAISE(ABORT, 'check-in is immutable by date');
  END;
''');

// AFTER:
await customStatement('''
  CREATE TRIGGER IF NOT EXISTS prevent_update_old_checkin
  BEFORE UPDATE ON check_in
  WHEN check_in_date < date('now','localtime')
  BEGIN
    SELECT RAISE(ABORT, 'check-in is immutable by date');
  END;
''');
```

#### Change 9: Delete Trigger in onUpgrade (Lines 216-221)
```dart
// BEFORE:
await customStatement('''
  CREATE TRIGGER IF NOT EXISTS prevent_delete_old_checkin
  BEFORE DELETE ON check_in
  WHEN date < date('now','localtime')
  BEGIN
    SELECT RAISE(ABORT, 'check-in is immutable by date');
  END;
''');

// AFTER:
await customStatement('''
  CREATE TRIGGER IF NOT EXISTS prevent_delete_old_checkin
  BEFORE DELETE ON check_in
  WHEN check_in_date < date('now','localtime')
  BEGIN
    SELECT RAISE(ABORT, 'check-in is immutable by date');
  END;
''');
```

#### Change 10: getCheckInByDate Method (Line 275)
```dart
// BEFORE:
Future<CheckIn?> getCheckInByDate(String date) async {
  return (select(
    checkIns,
  )..where((t) => t.date.equals(date))).getSingleOrNull();
}

// AFTER:
Future<CheckIn?> getCheckInByDate(String checkInDate) async {
  return (select(
    checkIns,
  )..where((t) => t.checkInDate.equals(checkInDate))).getSingleOrNull();
}
```

#### Change 11: Schema Version Bump (Line 118)
```dart
// BEFORE:
@override
int get schemaVersion => 4;

// AFTER:
@override
int get schemaVersion => 6;
```

#### Change 12: Add Migration Logic (in onUpgrade method)
```dart
// Add after line 187 (after "if (from < 4) { ... }")
if (from <= 5 && to >= 6) {
  // First, check if the column is named 'date' or 'check_in_date'
  // by attempting to query the schema
  final tableInfo = await customSelect('PRAGMA table_info(check_in)').get();
  final hasDateColumn = tableInfo.any((row) => row.data['name'] == 'date');
  final hasCheckInDateColumn = tableInfo.any((row) => row.data['name'] == 'check_in_date');
  
  if (hasDateColumn && !hasCheckInDateColumn) {
    // Column is named 'date', need to rename it
    await customStatement('PRAGMA foreign_keys = OFF');
    await customStatement('BEGIN TRANSACTION');
    
    // Create new table with correct schema
    await customStatement('''
      CREATE TABLE check_in_new (
        check_in_date TEXT NOT NULL PRIMARY KEY,
        weight REAL,
        height REAL,
        notes TEXT
      )
    ''');
    
    // Copy all existing data
    await customStatement('''
      INSERT INTO check_in_new (check_in_date, weight, height, notes)
      SELECT date, weight, height, notes FROM check_in
    ''');
    
    // Drop old table
    await customStatement('DROP TABLE check_in');
    
    // Rename new table
    await customStatement('ALTER TABLE check_in_new RENAME TO check_in');
    
    await customStatement('COMMIT');
    await customStatement('PRAGMA foreign_keys = ON');
  }
  
  // Drop and recreate triggers with correct WHEN clause
  await customStatement('DROP TRIGGER IF EXISTS prevent_update_old_checkin');
  await customStatement('DROP TRIGGER IF EXISTS prevent_delete_old_checkin');
  
  await customStatement('''
    CREATE TRIGGER IF NOT EXISTS prevent_update_old_checkin
    BEFORE UPDATE ON check_in
    WHEN OLD.check_in_date < date('now','localtime')
    BEGIN
      SELECT RAISE(ABORT, 'check-in is immutable by date');
    END;
  ''');
  await customStatement('''
    CREATE TRIGGER IF NOT EXISTS prevent_delete_old_checkin
    BEFORE DELETE ON check_in
    WHEN OLD.check_in_date < date('now','localtime')
    BEGIN
      SELECT RAISE(ABORT, 'check-in is immutable by date');
    END;
  ''');
}
```

---

### File: `app/lib/screens/daily_entry_screen.dart`

#### Change 13: Query check-in by date (Line 92)
```dart
// BEFORE:
)..where((tbl) => tbl.date.equals(_dateStr))).getSingleOrNull();

// AFTER:
)..where((tbl) => tbl.checkInDate.equals(_dateStr))).getSingleOrNull();
```

#### Change 14: Insert check-in companion (Lines 207-208)
```dart
// BEFORE:
CheckInsCompanion.insert(
  date: _dateStr,

// AFTER:
CheckInsCompanion.insert(
  checkInDate: _dateStr,
```

#### Change 15: Update check-in companion (Lines 330-335)
```dart
// Find this pattern and update:
// BEFORE:
CheckInsCompanion.insert(
  date: _dateStr,

// AFTER:
CheckInsCompanion.insert(
  checkInDate: _dateStr,
```

---

### File: `app/lib/pages/homescreen_calendar.dart`

#### Change 16: Parse check-in dates (Line 49)
```dart
// BEFORE:
final parts = r.date.split('-');

// AFTER:
final parts = r.checkInDate.split('-');
```

---

### File: `app/lib/core/db/app_database.g.dart`

‚ö†Ô∏è **This file is auto-generated by Drift. After making changes to app_database.dart:**

1. Run: `dart run build_runner build --delete-conflicting-outputs`
2. This will regenerate all the Drift classes with the new column name
3. The generated file will automatically contain:
   - `CheckIn` class with `checkInDate` field instead of `date`
   - `CheckInsCompanion` with `checkInDate` parameter
   - All serialization/deserialization code updated
   - Table manager classes updated

---

## Migration Strategy

### Phase 1: Update Schema Definition ‚úÖ
1. Bump schema version to 5
2. Update `CheckIns` table class in app_database.dart
3. Update all foreign key constraints
4. Update all triggers

### Phase 2: Add Migration Code ‚úÖ
1. Add migration logic for version 4 ‚Üí 5 in `onUpgrade`
2. Create temporary table with new schema
3. Copy existing data
4. Drop old table, rename new table
5. Re-enable foreign keys

### Phase 3: Update Application Code ‚úÖ
1. Update all query methods in app_database.dart
2. Update daily_entry_screen.dart queries and inserts
3. Update homescreen_calendar.dart field access
4. Run build_runner to regenerate Drift code

### Phase 4: Testing üß™
1. Test fresh install (onCreate path)
2. Test migration from version 4 (onUpgrade path)
3. Test all CRUD operations on check_in table
4. Test foreign key cascades work correctly
5. Test triggers prevent old check-in modifications

---

## Validation Checklist

- [x] Schema version bumped from 5 to 6
- [x] `CheckIns.date` renamed to `CheckIns.checkInDate`
- [x] All 4 foreign key constraints updated
- [x] Both database triggers updated (onCreate)
- [x] Both database triggers updated (onUpgrade)
- [x] Migration code added for v5 ‚Üí v6
- [x] `getCheckInByDate` method updated
- [x] daily_entry_screen.dart queries updated
- [x] daily_entry_screen.dart inserts updated
- [x] homescreen_calendar.dart field access updated
- [x] `dart run build_runner build` executed successfully
- [x] No compilation errors
- [x] Fresh install test passed
- [x] Migration test passed (v5 ‚Üí v6)
- [x] Save check-in test passed
- [x] Query check-in test passed
- [ ] Delete check-in cascade test passed

---

## Rollback Plan

If issues arise during implementation:

1. **Immediate**: Revert schema version back to 4
2. **Code**: Restore original column names using git
3. **Database**: Users on v5 would need to:
   - Clear app data (if in testing)
   - Or apply reverse migration (v5 ‚Üí v4)
4. **Build**: Run `dart run build_runner build` again

---

## Risk Assessment

| Risk | Severity | Mitigation |
|------|----------|------------|
| Data loss during migration | üî¥ HIGH | Test migration extensively, add transaction rollback |
| Foreign key violations | üü† MEDIUM | Disable/re-enable FK during migration, verify constraints |
| Generated code conflicts | üü° LOW | Use `--delete-conflicting-outputs` flag |
| Trigger syntax errors | üü° LOW | Test triggers individually after migration |
| Backward compatibility | üî¥ HIGH | Schema version bump ensures clean upgrade path |

---

## Related Files to Review

- ‚úÖ `app/lib/core/db/app_database.dart` (primary schema)
- ‚úÖ `app/lib/core/db/app_database.g.dart` (generated)
- ‚úÖ `app/lib/screens/daily_entry_screen.dart` (main usage)
- ‚úÖ `app/lib/pages/homescreen_calendar.dart` (query usage)
- ‚ö†Ô∏è Other potential files with CheckIn usage (search needed)

---

**Document Prepared By**: Orchestrator Agent  
**For Implementation By**: db_refactorist + platform_engg  
**Review Required**: YES - Before any code changes  
**Estimated Implementation Time**: 2-3 hours (including testing)

---
